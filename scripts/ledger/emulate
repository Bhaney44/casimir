#!/bin/bash
# Emulate ledger app
#
# Example:
#
#    scripts/ledger/emulate -a app-name (i.e. -a ethereum)
#
# Further information:
# See https://github.com/LedgerHQ/speculos
#

# Get args
while getopts a: flag
do
    case "${flag}" in
        a) app=${OPTARG};;
    esac
done

if [ -z "$app" ]; then
    app="ethereum"
    echo "app is not set, using default app $app"
fi

resource_path=scripts/ledger/resources

if [ ! -f "$resource_path/speculos/apps/$app.elf" ]; then
    echo "App $app not ready yet, running compile script"
    npm run compile:ledger --application=$app
fi

if [[ "$(uname -a)" = *ARM64* ]]; then
    echo 'Running emulator on ARM64'
    dockerfile=../custom/speculos-aarch64.Dockerfile
else
    echo 'Running emulator on x86_64'
    dockerfile=./Dockerfile
fi

# Emulate ledger app with speculos
echo "ðŸ“º Emulating $app app on ledger"
cd $resource_path/speculos
docker build . --tag speculos -f $dockerfile
sudo docker run --rm -it -v "$(pwd)/apps:/speculos/apps" speculos --display text apps/$app.elf