#!/bin/bash
# Emulate ledger with speculos
#
# Example:
#
#    scripts/ledger/emulate -a app-name -d device-name (i.e. -a ethereum -d nanos)
#
# Further information:
# See https://github.com/LedgerHQ/speculos
#

# Get args
while getopts a:d: flag
do
    case "${flag}" in
        a) app=${OPTARG};;
        d) device=${OPTARG};;
    esac
done

if [ ${npm_config_app+x} ]; then
    app=$npm_config_app
fi

if [ ${npm_config_device+x} ]; then
    device=$npm_config_device
fi

if [ -z "$app" ]; then
    app="ethereum"
    echo "app is not set, using default app $app"
fi

if [ -z "$device" ]; then
    device="nanos"
    echo "device is not set, using default device $device"
fi


current_dir=$(pwd)
apps_path=scripts/ledger/apps

# Build ledger app builder and compile app
echo "ðŸ”¨ Building $app app on ledger $device"
echo "Enter sudo password for building priveledged ledger-app-builder"
sudo docker build . --platform linux/x86_64 --tag ledger-app-builder:latest -f $apps_path/ledger-app-builder/Dockerfile
echo "Enter sudo password for running priveledged ledger-app-builder"
echo "Enter 'make' to build app and complete build"
sudo docker run --platform linux/x86_64 --rm -ti -v "$current_dir/$apps_path/$app:/app" ledger-app-builder:latest

# Emulate ledger app with speculos
echo "ðŸ“º Emulating $app app on ledger $device"
echo "Enter sudo password for building priveledged speculos"
sudo docker build . --platform linux/x86_64 --tag speculos:latest -f $apps_path/speculos/Dockerfile
echo "Enter sudo password for running priveledged speculos"
sudo docker run --platform linux/x86_64 --rm -it -v "$current_dir/$apps_path:/speculos/apps" --publish 41000:41000 speculos:latest --display headless --vnc-port 41000 $apps_path/$app/app.elf


